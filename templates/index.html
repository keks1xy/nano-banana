<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Nano Banana</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body {
      background:#0f1115;
      color:#e5e7eb;
      font-family:Inter,sans-serif;
      margin:0;
    }
    .container {
      max-width:980px;
      margin:0 auto;
      padding:32px;
    }
    textarea {
      width:100%;
      min-height:90px;
      background:#161a22;
      border:1px solid #222631;
      border-radius:14px;
      padding:14px;
      color:#fff;
    }
    select,button {
      background:#161a22;
      color:#fff;
      border:1px solid #222631;
      border-radius:10px;
      padding:10px 14px;
    }
    button.primary {
      background:#6366f1;
      border:none;
      cursor:pointer;
    }
    .row {
      display:flex;
      gap:12px;
      margin-top:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .status { margin-top:10px; color:#9ca3af; }
    .gallery {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:16px;
      margin-top:20px;
    }
    .history {
      margin-top:32px;
    }
    .history h2 {
      margin:0 0 12px 0;
      font-size:18px;
      color:#cbd5e1;
    }
    .card {
      position:relative;
      background:#161a22;
      border-radius:14px;
      overflow:hidden;
    }
    .card img {
      width:100%;
      cursor:pointer;
    }
    .select {
      position:absolute;
      top:10px;
      left:10px;
      transform:scale(1.3);
    }
    .download {
      position:absolute;
      right:10px;
      bottom:10px;
      background:rgba(0,0,0,.6);
      padding:6px 10px;
      border-radius:8px;
      color:#fff;
      text-decoration:none;
    }
    .modal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.9);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .modal img {
      max-width:90%;
      max-height:90%;
      border-radius:14px;
    }
    .modal.show { display:flex; }
    .ref-row {
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .ref-label {
      color:#cbd5e1;
      font-weight:600;
      font-size:14px;
    }
    .ref-previews {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      min-height:44px;
    }
    .ref-chip {
      width:44px;
      height:44px;
      border-radius:12px;
      background:#1f2430;
      border:1px solid #222631;
      background-size:cover;
      background-position:center;
      position:relative;
    }
    .add-ref {
      display:flex;
      align-items:center;
      justify-content:center;
      width:44px;
      height:44px;
      border-radius:12px;
      border:1px dashed #3b82f6;
      background:#161a22;
      color:#3b82f6;
      cursor:pointer;
      font-size:20px;
      transition:background .2s,color .2s,border-color .2s;
    }
    .add-ref:hover {
      background:#1f2430;
      color:#60a5fa;
      border-color:#60a5fa;
    }
    .history-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:10px;
    }
    .history-card {
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background:#161a22;
      border:1px solid #1f2430;
    }
    .history-card img {
      width:100%;
      display:block;
    }
    .history-meta {
      position:absolute;
      left:8px;
      bottom:8px;
      right:8px;
      background:rgba(0,0,0,.6);
      border-radius:10px;
      padding:6px 8px;
      color:#e5e7eb;
      font-size:12px;
      line-height:1.4;
    }
  </style>
</head>

<body>
<div class="container">

<h1>Nano Banana üçå</h1>

<form method="post" enctype="multipart/form-data">
  <textarea name="prompt" placeholder="Describe what you want to generate..."></textarea>

  <div class="ref-row">
    <div class="ref-label">References</div>
    <div id="ref-previews" class="ref-previews"></div>
    <button type="button" class="add-ref" onclick="document.getElementById('references').click()">+</button>
    <input id="references" type="file" name="references" accept="image/*" multiple style="display:none">
  </div>

  <div class="row">
    <select name="format">
      <option>1:1</option>
      <option>4:3</option>
      <option>16:9</option>
      <option>3:2</option>
      <option>2:3</option>
      <option>9:16</option>
    </select>

    <button class="primary">Generate</button>
  </div>
</form>

{% if status %}
<div class="status">
  Status: <span id="status">{{ status }}</span>
</div>
{% endif %}

<div class="row" style="margin-top:20px">
  <button onclick="downloadSelected()">üì¶ Download selected</button>
</div>

<div id="images" class="gallery"></div>

<div class="history">
  <h2>–ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
  <div id="history-grid" class="history-grid"></div>
</div>

</div>

<div id="modal" class="modal" onclick="closeModal()">
  <img id="modal-img">
</div>

<script>
const jobId = "{{ job_id }}";
const initialHistory = {{ history|tojson }};
const serverReferences = {{ references|tojson }};

const refInput = document.getElementById("references");
const refPreviews = document.getElementById("ref-previews");

function renderReferencePreviews(list) {
  if (!refPreviews) return;
  refPreviews.innerHTML = "";
  (list || []).forEach(ref => {
    const chip = document.createElement("div");
    chip.className = "ref-chip";
    chip.style.backgroundImage = `url('${ref.data_url || ref.previewUrl}')`;
    chip.title = ref.name || "reference";
    refPreviews.appendChild(chip);
  });
  if (!list || !list.length) {
    const placeholder = document.createElement("div");
    placeholder.style.color = "#6b7280";
    placeholder.style.fontSize = "13px";
    placeholder.innerText = "–î–æ–±–∞–≤—å—Ç–µ –¥–æ 5 —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–æ–≤";
    refPreviews.appendChild(placeholder);
  }
}

if (refInput) {
  refInput.addEventListener("change", () => {
    const previews = [...refInput.files].map(file => ({
      name: file.name,
      previewUrl: URL.createObjectURL(file)
    }));
    renderReferencePreviews(previews);
  });
}

renderReferencePreviews(serverReferences);
renderHistory(initialHistory);

async function checkStatus() {
  if (!jobId) return;
  const res = await fetch(`/status/${jobId}`);
  const data = await res.json();

  if (data.status !== "done") {
    setTimeout(checkStatus, 1000);
    return;
  }

  document.getElementById("status").innerText = "done ‚úÖ";
  renderImages(data.images);
  refreshHistory();
}

function renderImages(images) {
  const el = document.getElementById("images");
  el.innerHTML = "";

  images.forEach((url, i) => {
    const card = document.createElement("div");
    card.className = "card";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.className = "select";
    cb.value = url;

    const img = document.createElement("img");
    img.src = url;
    img.onclick = () => openModal(url);

    const dl = document.createElement("a");
    dl.href = url;
    dl.download = `image-${i+1}.jpg`;
    dl.className = "download";
    dl.innerText = "‚¨á";

    card.append(cb,img,dl);
    el.appendChild(card);
  });
}

function renderHistory(items) {
  const container = document.getElementById("history-grid");
  if (!container) return;
  container.innerHTML = "";

  const flatImages = (items || []).flatMap(item =>
    (item.images || []).map(url => ({
      url,
      prompt: item.prompt,
      job_id: item.job_id,
    }))
  );

  flatImages.forEach(entry => {
    const card = document.createElement("div");
    card.className = "history-card";

    const img = document.createElement("img");
    img.src = entry.url;
    img.alt = entry.prompt || "generated image";

    const meta = document.createElement("div");
    meta.className = "history-meta";
    meta.innerText = entry.prompt || "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞";

    card.append(img, meta);
    container.appendChild(card);
  });
}

async function refreshHistory() {
  const res = await fetch("/history");
  const data = await res.json();
  renderHistory(data.history || []);
}

async function downloadSelected() {
  const selected = [...document.querySelectorAll(".select:checked")].map(c=>c.value);
  if (!selected.length) return;

  const zip = new JSZip();
  for (let i=0;i<selected.length;i++) {
    const res = await fetch(selected[i]);
    zip.file(`image-${i+1}.jpg`, await res.blob());
  }
  saveAs(await zip.generateAsync({type:"blob"}), "nano-banana.zip");
}

function openModal(url) {
  document.getElementById("modal-img").src = url;
  document.getElementById("modal").classList.add("show");
}
function closeModal() {
  document.getElementById("modal").classList.remove("show");
}

if (jobId) {
  checkStatus();
} else {
  refreshHistory();
}
</script>

</body>
</html>
