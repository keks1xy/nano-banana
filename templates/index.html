<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Nano Banana</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root {
      --bg: #0b0d14;
      --card: #121623;
      --muted: #9ca3af;
      --accent: #7c3aed;
      --accent-2: #22c55e;
      --border: #1f2430;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family:Inter,sans-serif;
      color:#e5e7eb;
      background:radial-gradient(circle at 20% 20%, rgba(124,58,237,.15), transparent 35%),
                 radial-gradient(circle at 80% 30%, rgba(34,197,94,.15), transparent 40%),
                 radial-gradient(circle at 50% 80%, rgba(59,130,246,.18), transparent 35%),
                 #05070d;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .hero {
      position:relative;
      padding:32px 24px 120px;
      text-align:center;
      overflow:hidden;
    }
    .hero::after {
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(180deg, rgba(5,7,13,0) 0%, rgba(5,7,13,.85) 100%);
      pointer-events:none;
    }
    .title {
      font-size:36px;
      font-weight:700;
      letter-spacing:0.3px;
      margin:0;
      position:relative;
      z-index:1;
    }
    .sub {
      margin:10px 0 0;
      color:var(--muted);
      position:relative;
      z-index:1;
    }
    .top-bar {
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:12px;
      padding:0 24px 10px;
      position:relative;
      z-index:3;
      margin-top:-60px;
    }
    .gallery-wrap {
      padding:0 24px;
      margin-top:-20px;
      position:relative;
      z-index:2;
    }
    .gallery {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:12px;
      background:#060910aa;
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      backdrop-filter:blur(3px);
    }
    .card {
      position:relative;
      background:var(--card);
      border-radius:14px;
      overflow:hidden;
      border:1px solid #1e2432;
    }
    .card img {
      width:100%;
      display:block;
      cursor:pointer;
    }
    .select {
      position:absolute;
      top:10px;
      left:10px;
      transform:scale(1.2);
    }
    .control {
      opacity:0;
      transition:opacity .2s ease;
      pointer-events:none;
    }
    .card:hover .control {
      opacity:1;
      pointer-events:auto;
    }
    .download {
      position:absolute;
      right:10px;
      bottom:10px;
      background:rgba(0,0,0,.55);
      padding:6px 10px;
      border-radius:10px;
      color:#fff;
      text-decoration:none;
      border:1px solid rgba(255,255,255,.08);
    }
    .fav-btn {
      position:absolute;
      top:10px;
      right:44px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px;
      width:34px;
      height:34px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#fbbf24;
    }
    .panel {
      position:sticky;
      bottom:0;
      padding:16px 24px 26px;
      background:linear-gradient(135deg, rgba(12,15,24,0.95), rgba(10,12,20,0.95));
      box-shadow:0 12px 38px rgba(0,0,0,0.35);
      backdrop-filter:blur(12px);
      border-top:1px solid var(--border);
      border-radius:24px 24px 0 0;
      z-index:5;
    }
    form {
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:center;
      max-width:1100px;
      margin:0 auto;
    }
    .controls {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    select, button {
      background:var(--card);
      color:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 14px;
    }
    button.primary {
      background:linear-gradient(135deg,#a855f7,#6366f1);
      border:none;
      cursor:pointer;
      font-weight:700;
      padding:12px 16px;
    }
    .prompt-area {
      flex:1;
      min-width:280px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    textarea {
      width:100%;
      min-height:120px;
      background:#0d111b;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      color:#fff;
      resize:vertical;
    }
    .status { color:var(--muted); }
    .ref-row {
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .ref-label {
      color:#cbd5e1;
      font-weight:600;
      font-size:14px;
    }
    .ref-previews {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      min-height:44px;
    }
    .ref-chip {
      width:44px;
      height:44px;
      border-radius:12px;
      background:#1f2430;
      border:1px solid #222631;
      background-size:cover;
      background-position:center;
    }
    .add-ref {
      display:flex;
      align-items:center;
      justify-content:center;
      width:44px;
      height:44px;
      border-radius:12px;
      border:1px dashed #3b82f6;
      background:#161a22;
      color:#3b82f6;
      cursor:pointer;
      font-size:20px;
      transition:background .2s,color .2s,border-color .2s;
    }
    .add-ref:hover {
      background:#1f2430;
      color:#60a5fa;
      border-color:#60a5fa;
    }
    .error {
      color:#f87171;
      font-weight:600;
      margin-top:6px;
    }
  </style>
</head>

<body>
<div class="hero">
  <h1 class="title">Nano Banana x OFITSEROV AI üçå</h1>
  <p class="sub">–î–µ–ª–∞–µ–º –±—ã—Å—Ç—Ä–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ ‚Äî —É—Ç–æ—á–Ω–µ–Ω–∏—è @svyatoslavvvv (tg)</p>
</div>

<div class="top-bar">
  <button class="tab" id="tab-fav" onclick="toggleFavoritesFilter()">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</button>
</div>

<div class="gallery-wrap">
  <div id="images" class="gallery"></div>
</div>

<div class="panel">
  <form method="post" enctype="multipart/form-data" id="gen-form">
    <input type="hidden" id="stored_refs" name="stored_refs">
    <div class="controls">
      <div class="row">
        <select name="format" id="format">
          <option>1:1</option>
          <option>4:3</option>
          <option>16:9</option>
          <option>3:2</option>
          <option>2:3</option>
          <option>9:16</option>
          <option>5:4</option>
          <option>4:5</option>
          <option>7:4</option>
          <option>4:7</option>
          <option>5:3</option>
          <option>3:5</option>
          <option>21:9</option>
          <option>9:21</option>
          <option>2:1</option>
          <option>1:2</option>
          <option>3:1</option>
          <option>1:3</option>
          <option>5:2</option>
        </select>
        <button type="button" onclick="downloadSelected()">üì¶ Download selected</button>
      </div>
      {% if status %}
      <div class="status">Status: <span id="status">{{ status }}</span></div>
      {% endif %}
    </div>

    <div class="prompt-area">
      <div class="ref-row">
        <div class="ref-label">References</div>
        <div id="ref-previews" class="ref-previews"></div>
        <span style="color:var(--muted); font-size:13px;">–î–æ–±–∞–≤—å—Ç–µ –¥–æ 10 —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–æ–≤</span>
        <button type="button" class="add-ref" onclick="document.getElementById('references').click()">+</button>
        <input id="references" type="file" name="references" accept="image/*" multiple style="display:none">
      </div>

      <textarea name="prompt" id="prompt" placeholder="Describe what you want to generate... (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
      {% if error %}
        <div class="error">{{ error }}</div>
      {% endif %}
      <div style="display:flex; gap:10px; justify-content:flex-end; align-items:center;">
        <button class="primary">Generate</button>
      </div>
    </div>
  </form>

  <div class="history">
    <!-- –ò—Å—Ç–æ—Ä–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ—Ç–∫–µ —É–±—Ä–∞–Ω–∞. –ì–∞–ª–µ—Ä–µ—è –≤—ã—à–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏; –∫–Ω–æ–ø–∫–∞ "–ò–∑–±—Ä–∞–Ω–Ω—ã–µ" —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∏—Ö. -->
  </div>
</div>

<div id="modal" class="modal" onclick="closeModal()">
  <img id="modal-img">
</div>

<script>
const jobId = "{{ job_id }}";
const initialHistory = {{ history|tojson }};
const serverReferences = {{ references|tojson }};
const errorMessage = "{{ error or '' }}";

const refInput = document.getElementById("references");
const refPreviews = document.getElementById("ref-previews");
const storedRefsInput = document.getElementById("stored_refs");
const promptInput = document.getElementById("prompt");
const favTab = document.getElementById("tab-fav");

let allImages = [];
let showOnlyFavorites = false;

function loadSavedRefs() {
  const saved = localStorage.getItem("nb_refs");
  if (saved) {
    try { return JSON.parse(saved); } catch { return []; }
  }
  return [];
}

function saveRefs(list) {
  localStorage.setItem("nb_refs", JSON.stringify(list));
  storedRefsInput.value = JSON.stringify(list);
}

function renderReferencePreviews(list) {
  if (!refPreviews) return;
  refPreviews.innerHTML = "";
  (list || []).forEach(ref => {
    const chip = document.createElement("div");
    chip.className = "ref-chip";
    chip.style.backgroundImage = `url('${ref.data_url || ref.previewUrl}')`;
    chip.title = ref.name || "reference";
    refPreviews.appendChild(chip);
  });
  if (!list || !list.length) {
    const placeholder = document.createElement("div");
    placeholder.style.color = "#6b7280";
    placeholder.style.fontSize = "13px";
    placeholder.innerText = "–î–æ–±–∞–≤—å—Ç–µ –¥–æ 10 —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–æ–≤";
    refPreviews.appendChild(placeholder);
  }
}

function mergeInitialRefs() {
  const saved = loadSavedRefs();
  const merged = (serverReferences && serverReferences.length) ? serverReferences : saved;
  const limited = merged.slice(0, 10);
  saveRefs(limited);
  renderReferencePreviews(limited);
}

if (refInput) {
  refInput.addEventListener("change", () => {
    const current = loadSavedRefs();
    const uploads = [...refInput.files].map(file => ({
      name: file.name,
      previewUrl: URL.createObjectURL(file)
    }));
    const updated = [...current, ...uploads].slice(0, 10);
    saveRefs(updated);
    renderReferencePreviews(updated);
  });
}

function buildGalleryItems(historyItems) {
  const flat = (historyItems || []).flatMap(item =>
    (item.images || []).map(url => ({
      url,
      prompt: item.prompt,
      job_id: item.job_id,
    }))
  );
  // –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å–ø—Ä–∞–≤–∞ –≤ history, —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –±—ã–ª–∏ –ø–µ—Ä–≤—ã–º–∏
  return flat.reverse();
}

function renderGallery() {
  const el = document.getElementById("images");
  if (!el) return;
  el.innerHTML = "";

  const list = showOnlyFavorites ? allImages.filter(i => isFavorite(i.url)) : allImages;

  list.forEach((entry, i) => {
    const card = document.createElement("div");
    card.className = "card";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.className = "select";
    cb.value = entry.url;

    const fav = document.createElement("button");
    fav.className = "fav-btn control";
    fav.innerText = isFavorite(entry.url) ? "‚òÖ" : "‚òÜ";
    fav.onclick = (e) => { e.preventDefault(); toggleFavorite(entry.url); fav.innerText = isFavorite(entry.url) ? "‚òÖ" : "‚òÜ"; renderGallery(); };

    const img = document.createElement("img");
    img.src = entry.url;
    img.alt = entry.prompt || "generated image";
    img.onclick = () => openModal(entry.url);

    const meta = document.createElement("div");
    meta.className = "history-meta";
    meta.innerText = entry.prompt || "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞";

    const dl = document.createElement("a");
    dl.href = entry.url;
    dl.download = `image-${i+1}.jpg`;
    dl.className = "download control";
    dl.innerText = "‚¨á";

    card.append(cb,fav,img,meta,dl);
    el.appendChild(card);
  });
}

function setGalleryFromHistory(historyItems) {
  allImages = buildGalleryItems(historyItems);
  renderGallery();
}

async function checkStatus() {
  if (!jobId) return;
  const res = await fetch(`/status/${jobId}`);
  const data = await res.json();

  if (data.status !== "done") {
    setTimeout(checkStatus, 1000);
    return;
  }

  document.getElementById("status").innerText = "done ‚úÖ";
  await refreshHistory();
}

async function refreshHistory() {
  const res = await fetch("/history");
  const data = await res.json();
  setGalleryFromHistory(data.history || []);
}

async function downloadSelected() {
  const selected = [...document.querySelectorAll(".select:checked")].map(c=>c.value);
  if (!selected.length) return;

  const zip = new JSZip();
  for (let i=0;i<selected.length;i++) {
    const res = await fetch(selected[i]);
    zip.file(`image-${i+1}.jpg`, await res.blob());
  }
  saveAs(await zip.generateAsync({type:"blob"}), "nano-banana.zip");
}

function openModal(url) {
  document.getElementById("modal-img").src = url;
  document.getElementById("modal").classList.add("show");
}
function closeModal() {
  document.getElementById("modal").classList.remove("show");
}

function loadFavorites() {
  const raw = localStorage.getItem("nb_favs");
  if (!raw) return [];
  try { return JSON.parse(raw); } catch { return []; }
}

function saveFavorites(list) {
  localStorage.setItem("nb_favs", JSON.stringify(list));
}

function isFavorite(url) {
  return loadFavorites().includes(url);
}

function toggleFavorite(url) {
  const favs = loadFavorites();
  if (favs.includes(url)) {
    saveFavorites(favs.filter(x => x !== url));
  } else {
    favs.push(url);
    saveFavorites(favs);
  }
  renderGallery();
}

function toggleFavoritesFilter() {
  showOnlyFavorites = !showOnlyFavorites;
  if (showOnlyFavorites) {
    favTab.classList.add("active");
  } else {
    favTab.classList.remove("active");
  }
  renderGallery();
}

document.getElementById("gen-form").addEventListener("submit", (e) => {
  const val = (promptInput.value || "").trim();
  if (val.length < 10) {
    e.preventDefault();
    alert("–ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤");
    return false;
  }
  storedRefsInput.value = localStorage.getItem("nb_refs") || "[]";
});

mergeInitialRefs();
setGalleryFromHistory(initialHistory);

if (jobId) {
  checkStatus();
} else {
  refreshHistory();
}

if (errorMessage) {
  storedRefsInput.value = localStorage.getItem("nb_refs") || "[]";
}
</script>

</body>
</html>
