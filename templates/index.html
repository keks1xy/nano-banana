<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Nano Banana</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#05070d;
      --card:#121623;
      --muted:#9ca3af;
      --accent:#7c3aed;
      --border:#1f2430;
      --text:#e5e7eb;
      --chip:#1f2430;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:Inter,system-ui,sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 20% 20%, rgba(124,58,237,.15), transparent 35%),
        radial-gradient(circle at 80% 30%, rgba(34,197,94,.10), transparent 40%),
        radial-gradient(circle at 50% 80%, rgba(59,130,246,.12), transparent 35%),
        var(--bg);
      min-height:100vh;
    }
    .hero{
      padding:32px 24px 70px;
      text-align:center;
    }
    .title{
      margin:0;
      font-size:36px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .sub{
      margin:10px 0 0;
      color:var(--muted);
      font-size:14px;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:0 24px 120px;}
    .topbar{display:flex;justify-content:flex-end;gap:10px;margin:-30px 0 12px;}
    .btn{
      background:rgba(18,22,35,.75);
      color:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{opacity:.92;}
    .btn.primary{
      background:linear-gradient(135deg,#a855f7,#6366f1);
      border:none;
    }
    .btn.ghost{
      background:transparent;
      border:1px solid var(--border);
    }
    .btn.active{
      border-color:#60a5fa;
      box-shadow:0 0 0 3px rgba(96,165,250,.15);
    }

    .gallery{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(210px,1fr));
      gap:12px;
      background:#060910aa;
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      backdrop-filter:blur(4px);
      min-height:120px;
    }
    .card{
      position:relative;
      background:var(--card);
      border-radius:16px;
      overflow:hidden;
      border:1px solid #1e2432;
    }
    .card img{width:100%;display:block;cursor:pointer;}
    .select{
      position:absolute;top:10px;left:10px;transform:scale(1.2);
      z-index:2;
    }
    .control{
      opacity:0;
      transition:opacity .2s ease;
      pointer-events:none;
    }
    .card:hover .control{
      opacity:1;
      pointer-events:auto;
    }
    .download{
      position:absolute;right:10px;bottom:10px;
      background:rgba(0,0,0,.55);
      color:#fff;text-decoration:none;
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:7px 10px;
      z-index:2;
      font-weight:700;
    }
    .fav{
      position:absolute;top:10px;right:10px;
      background:rgba(0,0,0,.55);
      color:#fbbf24;
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      width:38px;height:38px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      z-index:2;
      font-size:18px;
    }
    .meta{
      padding:10px 12px;
      border-top:1px solid #1e2432;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .meta .prompt{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
    }

    .panel{
      position:fixed;
      left:0;right:0;bottom:0;
      padding:14px 24px 18px;
      background:linear-gradient(135deg, rgba(12,15,24,0.95), rgba(10,12,20,0.95));
      border-top:1px solid var(--border);
      backdrop-filter:blur(14px);
      box-shadow:0 12px 38px rgba(0,0,0,.40);
      z-index:20;
    }
    form{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      gap:14px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .leftControls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    select{
      background:rgba(18,22,35,.85);
      color:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-weight:600;
      cursor:pointer;
    }

    .status{
      color:var(--muted);
      font-size:13px;
      padding-top:10px;
      min-width:160px;
    }
    .status b{color:#fff;}

    .promptArea{
      flex:1;
      min-width:320px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .refRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .refLabel{font-weight:700;color:#cbd5e1;font-size:13px;}
    .refPreviews{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      min-height:44px;
      align-items:center;
    }
    .refChip{
      width:44px;height:44px;
      border-radius:14px;
      background:var(--chip);
      border:1px solid #222631;
      background-size:cover;
      background-position:center;
      position:relative;
      overflow:hidden;
    }
    .refChip .x{
      position:absolute;top:4px;right:4px;
      width:18px;height:18px;border-radius:999px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;
      cursor:pointer;
    }
    .addRef{
      width:44px;height:44px;border-radius:14px;
      border:1px dashed #60a5fa;
      background:rgba(18,22,35,.65);
      color:#60a5fa;
      font-size:20px;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    textarea{
      width:100%;
      min-height:110px;
      background:#0d111b;
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      color:#fff;
      resize:vertical;
      outline:none;
      font-size:14px;
      line-height:1.4;
    }
    .error{color:#f87171;font-weight:700;font-size:13px;}

    /* modal */
    .modal{
      position:fixed;inset:0;
      background:rgba(0,0,0,.88);
      display:none;
      align-items:center;justify-content:center;
      z-index:50;
    }
    .modal.show{display:flex;}
    .modalInner{
      max-width:92vw;max-height:92vh;
      display:flex;flex-direction:column;gap:10px;
      align-items:flex-end;
    }
    .modalImg{
      max-width:92vw;max-height:86vh;
      border-radius:18px;
      display:block;
    }
    .modalActions{
      display:flex;gap:10px;
    }

    @media (max-width: 700px){
      .status{min-width:unset;}
      .topbar{justify-content:center;}
    }
  </style>
</head>

<body>
  <div class="hero">
    <h1 class="title">Nano Banana üçå</h1>
    <div class="sub">Higgsfield-style UI ‚Ä¢ refs + history + zip</div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <button class="btn ghost" id="btnFav" type="button" onclick="toggleFavFilter()">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</button>
      <button class="btn" type="button" onclick="downloadSelected()">üì¶ Download selected</button>
    </div>

    <div id="images" class="gallery"></div>
  </div>

  <div class="panel">
    <form method="post" enctype="multipart/form-data" id="genForm">
      <input type="hidden" id="stored_refs" name="stored_refs" value="[]">

      <div class="leftControls">
        <select name="format" id="format">
          <option>1:1</option>
          <option>4:3</option>
          <option>16:9</option>
          <option>3:2</option>
          <option>2:3</option>
          <option>9:16</option>
          <option>5:4</option>
          <option>4:5</option>
          <option>21:9</option>
          <option>9:21</option>
          <option>2:1</option>
          <option>1:2</option>
          <option>3:1</option>
          <option>1:3</option>
          <option>5:2</option>
        </select>

        <select name="count" id="count">
          <option value="1">1 image</option>
          <option value="2">2 images</option>
          <option value="3">3 images</option>
          <option value="4" selected>4 images</option>
        </select>

        <button class="btn primary" type="submit">Generate</button>

        <div class="status">
          Status: <b id="statusText">{% if status %}{{ status }}{% else %}idle{% endif %}</b>
          {% if error %}<div class="error">{{ error }}</div>{% endif %}
        </div>
      </div>

      <div class="promptArea">
        <div class="refRow">
          <div class="refLabel">References</div>
          <div id="refPreviews" class="refPreviews"></div>
          <div class="addRef" onclick="document.getElementById('refInput').click()">+</div>
          <input id="refInput" type="file" accept="image/*" multiple style="display:none">
          <span style="color:var(--muted);font-size:12px;">–¥–æ 10 —à—Ç</span>
        </div>

        <textarea name="prompt" id="prompt" placeholder="Describe what you want to generate... (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
      </div>
    </form>
  </div>

  <div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modalInner">
      <div class="modalActions">
        <a id="modalDownload" class="btn" href="#" download>‚¨á –°–∫–∞—á–∞—Ç—å</a>
        <button class="btn" type="button" onclick="forceCloseModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <img id="modalImg" class="modalImg" src="">
    </div>
  </div>

<script>
  const jobId = "{{ job_id or '' }}";
  const initialHistory = {{ history|tojson }};
  const statusText = document.getElementById("statusText");

  // ===== Favorites =====
  const btnFav = document.getElementById("btnFav");
  let showFavOnly = false;

  function loadFavs(){
    try { return JSON.parse(localStorage.getItem("nb_favs") || "[]"); } catch { return []; }
  }
  function saveFavs(list){ localStorage.setItem("nb_favs", JSON.stringify(list)); }
  function isFav(url){ return loadFavs().includes(url); }
  function toggleFav(url){
    const f = loadFavs();
    if (f.includes(url)) saveFavs(f.filter(x=>x!==url));
    else { f.push(url); saveFavs(f); }
  }
  function toggleFavFilter(){
    showFavOnly = !showFavOnly;
    btnFav.classList.toggle("active", showFavOnly);
    renderGallery();
  }

  // ===== References (IMPORTANT: —Å–æ—Ö—Ä–∞–Ω—è–µ–º base64 data_url, –∞ –Ω–µ blob:) =====
  const refInput = document.getElementById("refInput");
  const refPreviews = document.getElementById("refPreviews");
  const storedRefs = document.getElementById("stored_refs");

  function getRefs(){
    try { return JSON.parse(localStorage.getItem("nb_refs") || "[]"); } catch { return []; }
  }
  function setRefs(list){
    const limited = (list || []).slice(0,10);
    localStorage.setItem("nb_refs", JSON.stringify(limited));
    storedRefs.value = JSON.stringify(limited);
    renderRefs(limited);
  }

  function renderRefs(list){
    refPreviews.innerHTML = "";
    if (!list.length){
      const t = document.createElement("div");
      t.style.color = "#6b7280";
      t.style.fontSize = "12px";
      t.innerText = "–î–æ–±–∞–≤—å—Ç–µ –¥–æ 10 —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–æ–≤";
      refPreviews.appendChild(t);
      return;
    }
    list.forEach((r, idx)=>{
      const chip = document.createElement("div");
      chip.className = "refChip";
      chip.style.backgroundImage = `url('${r.data_url}')`;

      const x = document.createElement("div");
      x.className = "x";
      x.innerText = "√ó";
      x.onclick = (e)=>{
        e.stopPropagation();
        const next = getRefs().filter((_,i)=>i!==idx);
        setRefs(next);
      };
      chip.appendChild(x);
      refPreviews.appendChild(chip);
    });
  }

  async function fileToDataUrl(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  if (refInput){
    refInput.addEventListener("change", async ()=>{
      const current = getRefs();
      const files = Array.from(refInput.files || []);
      for (const f of files){
        if (current.length >= 10) break;
        const dataUrl = await fileToDataUrl(f);
        current.push({ name: f.name, data_url: dataUrl });
      }
      setRefs(current);
      refInput.value = "";
    });
  }

  // ===== Gallery from server history =====
  let items = []; // {url, prompt, time}

  function flattenHistory(hist){
    const out = [];
    for (const job of (hist || [])){
      for (const url of (job.images || [])){
        out.push({
          url,
          prompt: job.prompt || "",
          time: job.time || "",
        });
      }
    }
    // –Ω–æ–≤—ã–µ –≤ –∫–æ–Ω—Ü–µ history -> –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
    return out.reverse();
  }

  function renderGallery(){
    const el = document.getElementById("images");
    el.innerHTML = "";

    let list = items;
    if (showFavOnly) list = list.filter(x=>isFav(x.url));

    if (!list.length){
      const empty = document.createElement("div");
      empty.style.color = "#6b7280";
      empty.style.padding = "18px";
      empty.innerText = "–ü–æ–∫–∞ –Ω–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–µ—Ä–≤—É—é üëá";
      el.appendChild(empty);
      return;
    }

    list.forEach((it, i)=>{
      const card = document.createElement("div");
      card.className = "card";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "select";
      cb.value = it.url;

      const fav = document.createElement("button");
      fav.type = "button";
      fav.className = "fav control";
      fav.innerText = isFav(it.url) ? "‚òÖ" : "‚òÜ";
      fav.onclick = (e)=>{
        e.preventDefault();
        toggleFav(it.url);
        renderGallery();
      };

      const img = document.createElement("img");
      img.src = it.url;
      img.onclick = ()=>openModal(it.url);

      const dl = document.createElement("a");
      dl.className = "download control";
      dl.href = it.url;
      dl.download = `image-${i+1}.png`;
      dl.innerText = "‚¨á";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `<div class="prompt">${escapeHtml(it.prompt || "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞")}</div><div>${escapeHtml(it.time || "")}</div>`;

      card.append(cb, fav, img, dl, meta);
      el.appendChild(card);
    });
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function refreshHistory(){
    const res = await fetch("/history");
    const data = await res.json();
    items = flattenHistory(data.history || []);
    renderGallery();
  }

  // ===== Download selected =====
  async function downloadSelected(){
    const selected = [...document.querySelectorAll(".select:checked")].map(x=>x.value);
    if (!selected.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —á–µ–∫–±–æ–∫—Å–∞–º–∏");

    const zip = new JSZip();
    const folder = zip.folder("nano-banana");

    for (let i=0;i<selected.length;i++){
      const url = selected[i];
      const resp = await fetch(url);
      const blob = await resp.blob();
      folder.file(`image-${i+1}.png`, blob);
    }

    const content = await zip.generateAsync({type:"blob"});
    saveAs(content, "nano-banana.zip");
  }
  window.downloadSelected = downloadSelected;

  // ===== Modal (–æ—Ç–∫—Ä—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ + —Å–∫–∞—á–∞—Ç—å) =====
  const modal = document.getElementById("modal");
  const modalImg = document.getElementById("modalImg");
  const modalDownload = document.getElementById("modalDownload");

  function openModal(url){
    modalImg.src = url;
    modalDownload.href = url;
    modalDownload.download = "nano-banana.png";
    modal.classList.add("show");
  }
  function closeModal(e){
    // –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ —Ñ–æ–Ω—É
    if (e.target === modal) forceCloseModal();
  }
  function forceCloseModal(){
    modal.classList.remove("show");
    modalImg.src = "";
  }
  window.closeModal = closeModal;
  window.forceCloseModal = forceCloseModal;

  // ===== Polling status (FIX: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ error) =====
  async function checkStatus(){
    if (!jobId) return;

    const res = await fetch(`/status/${jobId}`);
    const data = await res.json();

    if (data.status === "done"){
      statusText.innerText = "done ‚úÖ";
      await refreshHistory();
      return;
    }

    if (data.status === "error"){
      statusText.innerText = "error ‚ùå";
      alert("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: " + (data.error || "unknown"));
      return; // –í–ê–ñ–ù–û: –Ω–µ —É—Ö–æ–¥–∏–º –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
    }

    statusText.innerText = data.status || "processing";
    setTimeout(checkStatus, 1000);
  }

  // ===== Submit: –∫–ª–∞–¥—ë–º refs –≤ hidden –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º prompt =====
  const genForm = document.getElementById("genForm");
  const prompt = document.getElementById("prompt");

  genForm.addEventListener("submit", (e)=>{
    const text = (prompt.value || "").trim();
    if (text.length < 10){
      e.preventDefault();
      alert("–ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤");
      return false;
    }
    storedRefs.value = localStorage.getItem("nb_refs") || "[]";
    statusText.innerText = "queued";
  });

  // ===== Init =====
  setRefs(getRefs());            // refs UI
  items = flattenHistory(initialHistory || []);
  renderGallery();

  if (jobId) checkStatus();
  else refreshHistory();
</script>
</body>
</html>
