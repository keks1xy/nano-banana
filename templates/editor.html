<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Nano Banana — Editor</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
  <style>
    :root { --bg:#0b0d14; --panel:#111827; --card:#0f172a; --muted:#9ca3af; --accent:#6366f1; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:Inter,sans-serif; background:var(--bg); color:#e5e7eb; }
    .canvas-wrap { position:relative; width:100vw; height:100vh; overflow:hidden; }
    svg { position:absolute; inset:0; pointer-events:none; }
    .node {
      position:absolute; width:220px; min-height:120px; padding:12px;
      background:var(--card); border:1px solid #1f2937; border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25); user-select:none; cursor:grab;
    }
    .node:active { cursor:grabbing; }
    .node h3 { margin:0 0 8px 0; font-size:14px; font-weight:600; }
    .slot-row { display:flex; gap:8px; align-items:center; margin:6px 0; }
    .dot { width:12px; height:12px; border-radius:50%; background:var(--accent); }
    .dot.out { margin-left:auto; }
    textarea { width:100%; min-height:80px; background:#0b1220; color:#fff; border:1px solid #1f2937; border-radius:10px; padding:8px; resize:vertical; }
    .upload { width:100%; background:#0b1220; border:1px dashed #1f2937; border-radius:10px; padding:10px; text-align:center; color:var(--muted); font-size:13px; }
    .panel { position:absolute; right:16px; bottom:16px; background:var(--panel); padding:12px; border-radius:12px; border:1px solid #1f2937; display:flex; gap:8px; align-items:center; }
    select, button { background:#0b1220; color:#fff; border:1px solid #1f2937; border-radius:8px; padding:8px 10px; }
    button.primary { background:linear-gradient(135deg,#a855f7,#6366f1); border:none; font-weight:700; cursor:pointer; }
    #results { display:grid; gap:8px; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); }
    .thumb { background:#0b1220; border:1px solid #1f2937; border-radius:10px; overflow:hidden; }
    .thumb img { width:100%; display:block; }
    .status { color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <div class="canvas-wrap" id="canvas">
    <svg id="wires"></svg>

    <div class="node" id="node-text" style="left:40px; top:40px;">
      <h3>Text</h3>
      <textarea id="prompt" placeholder="Write something..."></textarea>
      <div class="slot-row"><div class="dot out" data-out="prompt"></div></div>
    </div>

    <div class="node" id="node-img1" style="left:40px; top:220px;">
      <h3>Image</h3>
      <div class="upload">Add or connect an image</div>
      <input type="file" accept="image/*" data-ref="1" style="margin-top:8px;width:100%;">
      <div class="slot-row"><div class="dot out" data-out="img1"></div></div>
    </div>

    <div class="node" id="node-img2" style="left:40px; top:380px;">
      <h3>Image Copy</h3>
      <div class="upload">Add or connect an image</div>
      <input type="file" accept="image/*" data-ref="2" style="margin-top:8px;width:100%;">
      <div class="slot-row"><div class="dot out" data-out="img2"></div></div>
    </div>

    <div class="node" id="node-img3" style="left:40px; top:540px;">
      <h3>Image Copy</h3>
      <div class="upload">Add or connect an image</div>
      <input type="file" accept="image/*" data-ref="3" style="margin-top:8px;width:100%;">
      <div class="slot-row"><div class="dot out" data-out="img3"></div></div>
    </div>

    <div class="node" id="node-engine" style="left:520px; top:180px; width:260px; min-height:200px;">
      <h3>Nano Banana Pro</h3>
      <div class="status" id="engine-status">Results will appear here</div>
      <div id="results" style="margin-top:8px;"></div>
      <div class="slot-row" style="margin-top:8px;">
        <div class="dot" data-in="prompt"></div>
        <span style="font-size:13px;color:var(--muted);">Prompt</span>
      </div>
      <div class="slot-row">
        <div class="dot" data-in="img1"></div>
        <div class="dot" data-in="img2"></div>
        <div class="dot" data-in="img3"></div>
      </div>
    </div>

    <div class="panel">
      <label style="color:var(--muted);font-size:13px;">Aspect</label>
      <select id="aspect">
        <option>1:1</option><option>4:3</option><option>16:9</option>
        <option>3:2</option><option>2:3</option><option>9:16</option>
      </select>
      <label style="color:var(--muted);font-size:13px;">Count</label>
      <select id="count"><option>1</option><option>2</option><option>3</option><option selected>4</option></select>
      <button class="primary" id="generate">Generate</button>
      <span class="status" id="status-text"></span>
    </div>
  </div>

  <script>
    const nodes = {
      prompt: document.getElementById('node-text'),
      img1: document.getElementById('node-img1'),
      img2: document.getElementById('node-img2'),
      img3: document.getElementById('node-img3'),
      engine: document.getElementById('node-engine'),
    };
    const wires = document.getElementById('wires');
    const edges = [
      { from: 'node-text', out: 'prompt', to: 'node-engine', in: 'prompt', color: '#facc15' },
      { from: 'node-img1', out: 'img1', to: 'node-engine', in: 'img1', color: '#60a5fa' },
      { from: 'node-img2', out: 'img2', to: 'node-engine', in: 'img2', color: '#60a5fa' },
      { from: 'node-img3', out: 'img3', to: 'node-engine', in: 'img3', color: '#60a5fa' },
    ];

    function centerOfDot(dot) {
      const r = dot.getBoundingClientRect();
      return { x: r.left + r.width/2 + window.scrollX, y: r.top + r.height/2 + window.scrollY };
    }
    function drawEdges() {
      wires.innerHTML = '';
      edges.forEach(edge => {
        const from = document.querySelector(`#${edge.from} [data-out="${edge.out}"]`);
        const to = document.querySelector(`#${edge.to} [data-in="${edge.in}"]`);
        if (!from || !to) return;
        const a = centerOfDot(from), b = centerOfDot(to);
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        const dx = Math.abs(b.x - a.x) * 0.6;
        const d = `M ${a.x} ${a.y} C ${a.x+dx} ${a.y}, ${b.x-dx} ${b.y}, ${b.x} ${b.y}`;
        path.setAttribute('d', d);
        path.setAttribute('stroke', edge.color || '#6366f1');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        wires.appendChild(path);
      });
    }

    function enableDrag(el) {
      let offsetX=0, offsetY=0, dragging=false;
      el.addEventListener('mousedown', e => {
        dragging=true;
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
      });
      window.addEventListener('mousemove', e => {
        if (!dragging) return;
        el.style.left = `${e.clientX - offsetX}px`;
        el.style.top = `${e.clientY - offsetY}px`;
        drawEdges();
      });
      window.addEventListener('mouseup', ()=> dragging=false);
    }
    Object.values(nodes).forEach(enableDrag);
    window.addEventListener('resize', drawEdges);
    drawEdges();

    // references data
    const refData = {};
    document.querySelectorAll('input[type="file"][data-ref]').forEach(input => {
      input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const dataUrl = await fileToDataUrl(file);
        refData[e.target.dataset.ref] = { name: file.name, data_url: dataUrl };
      });
    });
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    const statusText = document.getElementById('status-text');
    const engineStatus = document.getElementById('engine-status');
    const resultsGrid = document.getElementById('results');

    async function generate() {
      const promptVal = document.getElementById('prompt').value;
      const aspect = document.getElementById('aspect').value;
      const count = document.getElementById('count').value;

      const refs = Object.values(refData).slice(0,10);
      const fd = new FormData();
      fd.append('prompt', promptVal);
      fd.append('format', aspect);
      fd.append('count', count);
      fd.append('stored_refs', JSON.stringify(refs));

      statusText.innerText = 'Sending...';
      engineStatus.innerText = 'Processing...';
      try {
        const res = await fetch('/api/generate', { method:'POST', body: fd });
        if (!res.ok) {
          const err = await res.json().catch(()=>({error:'error'}));
          throw new Error(err.error || 'Ошибка генерации');
        }
        const data = await res.json();
        pollStatus(data.job_id);
      } catch (e) {
        statusText.innerText = e.message;
        engineStatus.innerText = 'Error';
      }
    }

    async function pollStatus(jobId) {
      statusText.innerText = 'processing...';
      const res = await fetch(`/status/${jobId}`);
      const data = await res.json();
      if (data.status !== 'done') {
        setTimeout(()=>pollStatus(jobId), 1000);
        return;
      }
      statusText.innerText = 'done';
      engineStatus.innerText = 'Done';
      renderResults(data.images || []);
    }

    function renderResults(images) {
      resultsGrid.innerHTML = '';
      images.forEach(url => {
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        const img = document.createElement('img');
        img.src = url;
        wrap.appendChild(img);
        resultsGrid.appendChild(wrap);
      });
    }

    document.getElementById('generate').addEventListener('click', generate);
  </script>
</body>
</html>
